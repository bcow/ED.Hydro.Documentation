---
title: "03-Leaf_Parameters"
output: html_document
---

# (PART) Key Leaf Traits {-}

--------------------------------------------------------------------------------

# `[leaf_psi_osmotic]:` Leaf osmotic water potential at saturation {-}

## ED  {-}

- ED variable name : `leaf_psi_osmotic`
- ED variable units: `m`

## BETY  {-}

NOTE!! The units are NEGATIVE in the database 
so we can calculate a distribution that is entirely negative. 

- Variable id: `1000000295` 
- Prior id: `1000000388`

## Calculation  {-}

### Expert elicitation  {-}

Expert elicitation provided by Brad Christoffersen 

- FATES varaiable name: `pinot_node (leaf)`
- FATES variable units: `MPa`

### Conversion  {-}
`MPa to m`

## Code {-}

```{r calc leaf_psi_osmotic}
i <- which(priors$ED_name == "leaf_psi_osmotic")

prior_in <- priors[i, stats] * MPa2m
myfit <- prior_get_fit(prior_in, accepted_dists, plot = TRUE)
myfit$score$dist[which.min(myfit$score$RMSE)]

variable_id.in <- tbl(bety,"variables") %>% filter(name == priors$ED_name[i]) %>% pull(id)
phylogeny.in <- "plants"

best.fit.name <- myfit$score$dist[which.min(myfit$score$RMSE)]
best.fit.dat <- myfit$dists %>% select(one_of("Name", best.fit.name)) %>% rename(value := !!best.fit.name, params = Name)

leaf_psi_osmotic_prior_id <- prior_input(bety, variable_id.in, phylogeny.in, 
                                         dist.name.in = best.fit.name, 
                                         parama.in = best.fit.dat %>% filter(params == "Para1") %>% pull(value), 
                                         paramb.in = best.fit.dat %>% filter(params == "Para2") %>% pull(value), 
                                         paramc.in = best.fit.dat %>% filter(params == "Para3") %>% pull(value))

```

```{r plot leaf_psi_osmotic}
leaf_psi_osmotic_fit <- tbl(bety, "priors") %>% filter(id == leaf_psi_osmotic_prior_id) %>% collect()
leaf_psi_osmotic_prior <- -rdistn(leaf_psi_osmotic_fit) # NOTE: Need to convert to m from -m 
leaf_psi_osmotic_default <- get_ED_default("/fs/data3/ecowdery/ED.Hydro/parameters/pft3_defaults_history.xml", "leaf_psi_osmotic")

prior_plot(prior = leaf_psi_osmotic_prior, 
           q = c(0,1), 
           plot_default = leaf_psi_osmotic_default,
           title = sprintf(" (leaf_psi_osmotic): %s", leaf_psi_osmotic_fit$distn),
           type = "data")
```

--------------------------------------------------------------------------------

# `[leaf_elastic_mod]`: Leaf bulk elastic modulus {-}

## ED  {-}

- ED variable name : `leaf_elastic_mod`
- ED variable units: `MPa` Note! This is the only case in which MPa is used instead of m!

## BETY  {-}

- Variable id: `1000000294`
- Prior id: `1000000387`

## Calculation  {-}

### Expert elicitation {-}

Expert elicitation provided by Brad Christoffersen 

- FATES varaiable name: `epsil_node (leaf)` 
- FATES variable units: `MPa`

### Conversion {-}

None!

## Code {-}

```{r calc leaf_elastic_mod}
i <- which(priors$ED_name == "leaf_elastic_mod")
prior_in <- priors[i,]
myfit <- prior_get_fit(prior_in, accepted_dists, plot = TRUE)

variable_id.in <- tbl(bety,"variables") %>% filter(name == priors$ED_name[i]) %>% pull(id)
phylogeny.in <- "plants"

best.fit.name <- myfit$score$dist[which.min(myfit$score$RMSE)]
best.fit.dat <- myfit$dists %>% select(one_of("Name", best.fit.name)) %>% rename(value := !!best.fit.name, params = Name)

leaf_elastic_mod_id <- prior_input(bety, variable_id.in, phylogeny.in, 
                                   dist.name.in = best.fit.name, 
                                   parama.in = best.fit.dat %>% filter(params == "Para1") %>% pull(value), 
                                   paramb.in = best.fit.dat %>% filter(params == "Para2") %>% pull(value), 
                                   paramc.in = best.fit.dat %>% filter(params == "Para3") %>% pull(value))


```

```{r plot leaf_elastic_mod}
leaf_elastic_mod_fit <- tbl(bety, "priors") %>% filter(id == leaf_elastic_mod_id) %>% collect()
leaf_elastic_mod_prior <- rdistn(leaf_elastic_mod_fit)
leaf_elastic_mod_default <- get_ED_default("/fs/data3/ecowdery/ED.Hydro/parameters/pft3_defaults_history.xml", "leaf_elastic_mod")

prior_plot(prior = leaf_elastic_mod_prior, 
           q = c(0,.995), 
           plot_default = leaf_elastic_mod_default,
           title = sprintf("Leaf bulk elastic modulus (leaf_elastic_mod): %s", leaf_elastic_mod_fit$distn),
           type = "data")
```

--------------------------------------------------------------------------------

# `[leaf_density]:` Density of leaf tissue {-}

## ED  {-}

- ED variable name : `leaf_density`
- ED variable units: `kg m-3`

## BETY  {-}

- Variable id: `1000000304`
- Prior id: `1000000396`

## Calculation  {-}

### Expert elicitation {-}

No expert elicitation provided by Brad Christoffersen. 

I will use the equation in ED to calcualte the prior and 
add min and max values to make sure the distribution 
does not predict values that are not biologically possible. 

Values added by Betsy and Felicien: 
```{r, eval = FALSE}
# Leaf_density
priors[which(priors$ED_name == "leaf_density"),
       c("theor.min", "theor.max")] <- c(1e-7, 2000)
```

Copies directly from the ED code: `max(0.1 * 1.e3, (leaf_elastic_mod(ipft) - 2.03) / 25.4 * 1.e3)`

But there is a key step here that we need to think about, which is that in the ED code, `0.1 * 1.e3` is the smallest possible value. I encorporate that information by setting `0.1 * 1.e3` as the min theoretical value when fitting the distribution (but remove the `max` from the equation when calculating the `leaf_density_sample`.)

`leaf_density_sample <- (leaf_elastic_mod_prior - 2.03) / 25.4 * 1.e3`

### Conversion {-}

None

## Code {-}

```{r calc leaf_density_sample}
leaf_density_sample <- (leaf_elastic_mod_prior - 2.03) / 25.4 * 1.e3

# Add in the max an min from the priors table
i <- which(priors$ED_name == "leaf_density")
prior_in <- priors[i,] # Note here I don't need to do any units conversion 
prior_in <- prior_add_samp_data(prior_in, samp = leaf_density_sample)
prior_in[,stats]

myfit <-  prior_get_fit(prior_in, accepted_dists, plot = TRUE)

variable_id.in <- tbl(bety,"variables") %>% filter(name == "leaf_density") %>% pull(id)
phylogeny.in <- "plants"

best.fit.name <- myfit$score$dist[which.min(myfit$score$RMSE)]
best.fit.dat <- myfit$dists %>% select(one_of("Name", best.fit.name)) %>% rename(value := !!best.fit.name, params = Name)

leaf_density_default <- (get_ED_default("/fs/data3/ecowdery/ED.Hydro/parameters/pft3_defaults_history.xml", "leaf_elastic_mod") - 2.03) / 25.4 * 1.e3

leaf_density_id <- prior_input(bety, variable_id.in, phylogeny.in, 
                               dist.name.in = best.fit.name, 
                               parama.in = best.fit.dat %>% filter(params == "Para1") %>% pull(value), 
                               paramb.in = best.fit.dat %>% filter(params == "Para2") %>% pull(value), 
                               paramc.in = best.fit.dat %>% filter(params == "Para3") %>% pull(value))
```

```{r plot leaf_density_sample}
leaf_density_fit <- tbl(bety, "priors") %>% filter(id == leaf_density_id) %>% collect()
leaf_density_prior <- rdistn(leaf_density_fit)

prior_plot(prior = leaf_density_prior, 
           q = c(0,.995),
           plot_default = leaf_density_default,
           title = sprintf("Leaf density (leaf_density): %s", leaf_density_fit$distn),
           type = "equation")
```

--------------------------------------------------------------------------------

# `[leaf_water_sat]:` Leaf water content at saturation {-}

## ED  {-}

- ED variable name : `leaf_water_sat`
- ED variable units: `kg H2O/kg biomass`

## BETY  {-}

- Variable id: `1000000285`
- Prior id: `1000000414`

## Calculation  {-}

There are a couple ways to approach this:

Either build a prior completely from other priors 
(ie using the equations from ED and a prior for LMA and leaf_density) 
or try to do a combination where we use the priovided expert elicitation 
and the prior distribution for leaf_density. 

I am going to try doing both just to see how they differ. 

### Expert elicitation {-}

Expert elicitation provided by Brad Christoffersen 

- FATES varaiable name: `thetas_node (leaf)`
- FATES variable units: `kg kg-1`

### Conversion {-}

The equations between the two are identical except that to get from 
FATES to ED, must multiply by `(water density)/(leaf density)`

## Code {-}

### Initial testing code {-}

```{r test calc leaf_water_sat}
leaf_density_prior_1 <- leaf_density_prior
leaf_density_prior_2 <- rlnorm(100000, 6.51, .59) # Also trying with lnorm, this is left over from a previous question but I'm including it for now so that the code runs 

# Following the equation in ED

SLA_density <-  get_ED_default("/fs/data3/ecowdery/ED.Hydro/parameters/pft3_defaults_history.xml", "SLA")
default_LMA <- 1e3 * 2 / SLA_density # 1.e3 * C2B / SLA(ipft)

leaf_water_sat_density <- get_ED_default("/fs/data3/ecowdery/ED.Hydro/parameters/pft3_defaults_history.xml", "leaf_water_sat")

leaf_water_sat_default_calc <- (-2.32e4 / default_LMA + 782.) * (1. / (-0.21 * log(1.e4 / default_LMA) + 1.43) - 1.) / leaf_density_default
# c(leaf_water_sat_density, leaf_water_sat_default_calc)

LMA_prior <- 1e3 * 2 / SLA_prior

# Should be analogous to Christoffersen because I'm dividing by wdns instead of leaf_density
leaf_water_sat_samp_1_1 <- 
  (-2.32e4 / LMA_prior + 782.) * 
  (1. / (-0.21 * log(1.e4 / LMA_prior) + 1.43) - 1.) / leaf_density_prior_1
leaf_water_sat_samp_1_2 <- 
  (-2.32e4 / LMA_prior + 782.) * 
  (1. / (-0.21 * log(1.e4 / LMA_prior) + 1.43) - 1.) / leaf_density_prior_2

prior_in_1_1 <- data.frame(low.025 =  quantile(leaf_water_sat_samp_1_1, c(.025), na.rm = TRUE),
                           low.25  =  quantile(leaf_water_sat_samp_1_1, c(.25), na.rm = TRUE),
                           mean    =  quantile(leaf_water_sat_samp_1_1, c(.5), na.rm = TRUE), 
                           upp.75  =  quantile(leaf_water_sat_samp_1_1, c(.75), na.rm = TRUE), 
                           upp.975 =  quantile(leaf_water_sat_samp_1_1, c(.975), na.rm = TRUE))

myfit_1_1 <-  prior_get_fit(prior_in_1_1, accepted_dists, plot = FALSE)
myfit_1_1$score$dist[which.min(myfit_1_1$score$RMSE)]
# I'm skipping steps here just for the sake of time & sanity
leaf_water_sat_prior_1_1 <- rexp(1000, myfit_1_1$dists$exp[1])

prior_in_1_2 <- data.frame(low.025 =  quantile(leaf_water_sat_samp_1_2, c(.025), na.rm = TRUE),
                           low.25  =  quantile(leaf_water_sat_samp_1_2, c(.25), na.rm = TRUE),
                           mean    =  quantile(leaf_water_sat_samp_1_2, c(.5), na.rm = TRUE), 
                           upp.75  =  quantile(leaf_water_sat_samp_1_2, c(.75), na.rm = TRUE), 
                           upp.975 =  quantile(leaf_water_sat_samp_1_2, c(.975), na.rm = TRUE))

myfit_1_2 <-  prior_get_fit(prior_in_1_2, accepted_dists, plot = FALSE)
myfit_1_2$score$dist[which.min(myfit_1_2$score$RMSE)]
# I'm skipping steps here just for the sake of time & sanity
leaf_water_sat_prior_1_2 <- rlnorm(1000, myfit_1_2$dists$lnorm[1], myfit_1_2$dists$lnorm[2])

# Using the data 
i <- which(priors$ED_name == "leaf_water_sat")

myfit_2 <- prior_get_fit(priors[i,], accepted_dists, plot = FALSE) 
myfit_2$score$dist[which.min(myfit_2$score$RMSE)]
# I'm skipping steps here just for the sake of time & sanity
leaf_water_sat_prior_2 <- rnorm(1000, myfit_2$dists$norm[1], myfit_2$dists$norm[2])

calc_2_1 <- leaf_water_sat_prior_2 * (wdns/(leaf_density_prior_1))
prior_in_2_1 <- data.frame(low.025 =  quantile(calc_2_1, c(.025), na.rm = TRUE),
                           low.25  =  quantile(calc_2_1, c(.25), na.rm = TRUE),
                           mean    =  quantile(calc_2_1, c(.5), na.rm = TRUE), 
                           upp.75  =  quantile(calc_2_1, c(.75), na.rm = TRUE), 
                           upp.975 =  quantile(calc_2_1, c(.975), na.rm = TRUE))
myfit_2_1 <-  prior_get_fit(prior_in_2_1, accepted_dists, plot = FALSE)
myfit_2_1$score$dist[which.min(myfit_2_1$score$RMSE)]
# I'm skipping steps here just for the sake of time & sanity
leaf_water_sat_prior_2_1 <- rlnorm(1000, myfit_2_1$dists$lnorm[1], myfit_2_1$dists$lnorm[2])


calc_2_2 <- leaf_water_sat_prior_2 * (wdns/(leaf_density_prior_2))
prior_in_2_2 <- data.frame(low.025 =  quantile(calc_2_2, c(.025), na.rm = TRUE),
                           low.25  =  quantile(calc_2_2, c(.25), na.rm = TRUE),
                           mean    =  quantile(calc_2_2, c(.5), na.rm = TRUE), 
                           upp.75  =  quantile(calc_2_2, c(.75), na.rm = TRUE), 
                           upp.975 =  quantile(calc_2_2, c(.975), na.rm = TRUE))
myfit_2_2 <-  prior_get_fit(prior_in_2_2, accepted_dists, plot = FALSE)
myfit_2_2$score$dist[which.min(myfit_2_2$score$RMSE)]
# I'm skipping steps here just for the sake of time & sanity
leaf_water_sat_prior_2_2 <- rlnorm(1000, myfit_2_2$dists$lnorm[1], myfit_2_2$dists$lnorm[2])

df <- data.frame(leaf_water_sat_prior_1_1, leaf_water_sat_prior_1_2, 
                 leaf_water_sat_prior_2_1, leaf_water_sat_prior_2_2)
df2 <- df %>% 
  gather(key = "prior") %>% 
  mutate(leaf_dens_dist = case_when(
    prior == "leaf_water_sat_prior_1_1" ~ "Weibull",
    prior == "leaf_water_sat_prior_1_2" ~ "Log Normal",
    prior == "leaf_water_sat_prior_2_1" ~ "Weibull",
    prior == "leaf_water_sat_prior_2_2" ~ "Log Normal"
  )) %>% 
  mutate(prior_or_data = case_when(
    prior == "leaf_water_sat_prior_1_1" ~ "LMA_prior",
    prior == "leaf_water_sat_prior_1_2" ~ "LMA_prior",
    prior == "leaf_water_sat_prior_2_1" ~ "leaf_water_sat_exp_elicit",
    prior == "leaf_water_sat_prior_2_2" ~ "leaf_water_sat_exp_elicit"
  ))

ggplot(data = df2) + 
  geom_density(aes(x = value, color = prior_or_data, linetype = leaf_dens_dist)) + 
  geom_vline(aes(xintercept = leaf_water_sat_density)) +
  geom_point(aes(x = .03, y = 0)) + geom_point(aes(x = 1.5, y = 0)) + geom_point(aes(x = 2, y = 0)) +
  xlim(-.25, 4)

```

From this point, we can see that just using the equations in the ED code makes 
the distributions predict low values which is could be a problem given that 
these values should not be zero and that the distribution underpredicts both 
in relation to the default value and the values that Felicien gave me. 

Thus I would create the prior using the expert elicitation values provided by Brad. 
I am also comfortable with chooseing the best fit distribution for leaf_density
which is the weibull distribution instead of trying to come up with a reason 
why we should make leaf density log normal instead. 
The log normal was the best if I didn't include the lower bound - that's why I wanted to look at it... 

### Actual code {-}

```{r calc leaf_water_sat}

i <- which(priors$ED_name == "leaf_water_sat")
myfit_0 <- prior_get_fit(priors[i,], accepted_dists, plot = FALSE)  

myfit_0$score$dist[which.min(myfit_0$score$RMSE)]
# I'm skipping steps here just for the sake of time & sanity
leaf_water_sat_prior_0 <- rnorm(100000, myfit_0$dists$norm[1], myfit_0$dists$norm[2])

leaf_water_sat_sample <- leaf_water_sat_prior_0 * (wdns/(leaf_density_prior))

# plot(density(leaf_water_sat_sample), main = "leaf water sat sample without fitting")

# In this case I'm not using the function I built because here it wouldn't make sense. 
prior_in <- data.frame(low.025 =  quantile(leaf_water_sat_sample, c(.025), na.rm = TRUE),
                       low.25  =  quantile(leaf_water_sat_sample, c(.25), na.rm = TRUE),
                       mean    =  quantile(leaf_water_sat_sample, c(.5), na.rm = TRUE), 
                       upp.75  =  quantile(leaf_water_sat_sample, c(.75), na.rm = TRUE), 
                       upp.975 =  quantile(leaf_water_sat_sample, c(.975), na.rm = TRUE))
myfit <- prior_get_fit(prior_in, accepted_dists, plot = TRUE)

variable_id.in <- tbl(bety,"variables") %>% filter(name == priors$ED_name[i]) %>% pull(id)
phylogeny.in <- "plants"

best.fit.name <- myfit$score$dist[which.min(myfit$score$RMSE)]
best.fit.dat <- myfit$dists %>% select(one_of("Name", best.fit.name)) %>% rename(value := !!best.fit.name, params = Name)

leaf_water_sat_prior_id <- prior_input(bety, variable_id.in, phylogeny.in, 
                                       dist.name.in = best.fit.name, 
                                       parama.in = best.fit.dat %>% filter(params == "Para1") %>% pull(value), 
                                       paramb.in = best.fit.dat %>% filter(params == "Para2") %>% pull(value), 
                                       paramc.in = best.fit.dat %>% filter(params == "Para3") %>% pull(value))
```

```{r plot leaf_water_sat}
leaf_water_sat_fit <- tbl(bety, "priors") %>% filter(id == leaf_water_sat_prior_id) %>% collect()
leaf_water_sat_prior <- rdistn(leaf_water_sat_fit)
leaf_water_sat_density <- get_ED_default("/fs/data3/ecowdery/ED.Hydro/parameters/pft3_defaults_history.xml", "leaf_water_sat")

prior_plot(prior = leaf_water_sat_prior, 
           q = c(0,.995),
           plot_default = leaf_water_sat_density,
           title = sprintf("Leaf water content at saturation (leaf_water_sat): %s", leaf_water_sat_fit$distn),
           type = "mixed")

```


--------------------------------------------------------------------------------

# `[leaf_psi_tlp]:` Leaf water potential at turgor loss point {-}

## ED  {-}

- ED variable name : `leaf_psi_tlp`
- ED variable units: `m`

## BETY  {-}

- Variable id: `1000000284`
- Prior id: `1000000384`

NOTE!! The units are NEGATIVE in the database 
so we can calculate a distribution that is entirely negative. 

## Calculation  {-}

### Expert elicitation {-}

No expert elicitation provided by Brad Christoffersen. 

I will use the equation in ED to calcualte the prior and 
add min and max values to make sure the distribution 
does not predict values that are not biologically possible. 

Values added by Betsy and Felicien: 
```{r, eval = FALSE}
# Leaf_psi_tlp
priors[which(priors$ED_name == "leaf_psi_tlp"),
       c("theor.min", "theor.max")] <- c(-6, -0.5)
```

Code directly from ED: `leaf_elastic_mod(ipft)  * (leaf_psi_osmotic(ipft) / MPa2m) / (leaf_elastic_mod(ipft) + leaf_psi_osmotic(ipft) / MPa2m) * MPa2m`

Thus, `leaf_psi_tlp` is calculated purely from other parameters: `leaf_psi_osmotic` and `leaf_elastic_mod`

```{r, eval=FALSE}
leaf_psi_tlp_samp <- 
  (leaf_psi_osmotic_prior * (leaf_elastic_mod_prior * MPa2m))/
  (leaf_psi_osmotic_prior + (leaf_elastic_mod_prior * MPa2m))
```

### Conversion {-}

Remember that `leaf_elastic_mod` is `MPa`, where everything else is `m`! 

## Code {-}

```{r calc leaf_psi_tlp}

leaf_psi_tlp_samp <- 
  (leaf_psi_osmotic_prior * (leaf_elastic_mod_prior * MPa2m))/
  (leaf_psi_osmotic_prior + (leaf_elastic_mod_prior * MPa2m))

summary(leaf_psi_tlp_samp)

# Add in the max an min from the priors table
i <- which(priors$ED_name == "leaf_psi_tlp")
prior_in <- priors[i,stats] * MPa2m # Convert from MPa to m
prior_in <- prior_add_samp_data(prior_in, samp = -leaf_psi_tlp_samp)
prior_in[,stats]

myfit <- prior_get_fit(prior_in, accepted_dists, plot = TRUE)

variable_id.in <- tbl(bety, "variables") %>% filter(name == "leaf_psi_tlp") %>% pull(id)
phylogeny.in <- "plants"

best.fit.name <- myfit$score$dist[which.min(myfit$score$RMSE)]
best.fit.dat <- myfit$dists %>% select(one_of("Name", best.fit.name)) %>% rename(value := !!best.fit.name, params = Name)

leaf_psi_tlp_prior_id <- prior_input(bety, variable_id.in, phylogeny.in, 
                                     dist.name.in = best.fit.name, 
                                     parama.in = best.fit.dat %>% filter(params == "Para1") %>% pull(value), 
                                     paramb.in = best.fit.dat %>% filter(params == "Para2") %>% pull(value), 
                                     paramc.in = best.fit.dat %>% filter(params == "Para3") %>% pull(value))
```

```{r plot leaf_psi_tlp}
leaf_psi_tlp_fit <- tbl(bety, "priors") %>% filter(id == leaf_psi_tlp_prior_id) %>% collect()
leaf_psi_tlp_prior <- -rdistn(leaf_psi_tlp_fit) # Remember to flip back over for psi
leaf_psi_tlp_default <- get_ED_default("/fs/data3/ecowdery/ED.Hydro/parameters/pft3_defaults_history.xml", "leaf_psi_tlp")

# plot(density(leaf_psi_tlp_prior), main = "leaf_psi_tlp prior")
# abline(v = get_ED_default("/fs/data3/ecowdery/ED.Hydro/parameters/pft3_defaults_history.xml", "leaf_psi_tlp"), col = "blue", lwd = 2)
# abline(v = quantile(leaf_psi_osmotic_prior, c(.025, .975)), lty = 2)
# legend("topleft",legend=c("Prior", "95% CI", "ED PFT 3 Default"), col=c("black", "black","blue"), lwd = c(2,1,2), lty = c(1,2,1))

prior_plot(prior = leaf_psi_tlp_prior, 
           q = c(.005,1),
           plot_default = leaf_psi_tlp_default,
           title = sprintf("(leaf_psi_tlp): %s", leaf_psi_tlp_fit$distn),
           type = "equation")


```

--------------------------------------------------------------------------------

# `[leaf_water_cap]:` Leaf hydaulic capacitance. {-}

## ED  {-}

- ED variable name : `leaf_water_cap`
- ED variable units: `kg H2O/kg biomass/m`

## BETY  {-}

- Variable id: `1000000287`
- Prior id: `1000000405`

NOTE: units in BETY are `g H2O / kg biomass / m`! This is because we needed to multiply by 1000 to get large enough values to fit the distribution.

## Calculation  {-}

### Expert elicitation {-}

No expert elicitation provided by Brad Christoffersen. 

I will use the equation in ED to calcualte the prior and 
add min and max values to make sure the distribution 
does not predict values that are not biologically possible. 

Values added by Betsy and Felicien: 
```{r, eval = FALSE}
# Leaf_water_cap
priors[which(priors$ED_name == "leaf_water_cap"),
       c("theor.min", "theor.max")] <- c(1e-7, NA)
```

Equation copied directly from ED: `(1. - leaf_psi_osmotic(ipft) / (4. * leaf_psi_tlp(ipft))) * leaf_water_sat(ipft) / (4. * abs(leaf_psi_tlp(ipft)))`

### Conversion {-}

Don't forget about the switch from kg to g!

## Code {-}

```{r calc leaf_water_cap}
leaf_water_cap_samp <- 
  1000 * (1 - leaf_psi_osmotic_prior / (4 * leaf_psi_tlp_prior)) * 
  (leaf_water_sat_prior / (4 * abs(leaf_psi_tlp_prior))) # * (wdns/leaf_density_prior)

leaf_water_cap_samp <- leaf_water_cap_samp[0 < leaf_water_cap_samp]

default_leaf_water_cap <- get_ED_default("/fs/data3/ecowdery/ED.Hydro/parameters/pft3_defaults_history.xml", "leaf_water_cap")

plot(density(leaf_water_cap_samp))
abline(v = default_leaf_water_cap)

# Add in the max an min from the priors table
i <- which(priors$ED_name == "leaf_water_cap")
prior_in <- priors[i,stats] 
prior_in[,"theor.min"] <- NA
# prior_in[,"theor.max"] <- max(.35 * (1/MPa2m) * (wdns/leaf_density_prior) )
prior_in <- prior_add_samp_data(prior_in, samp = leaf_water_cap_samp)
prior_in[,stats]

myfit <- prior_get_fit(prior_in, accepted_dists, plot = TRUE)

variable_id.in <- tbl(bety, "variables") %>% filter(name == "leaf_water_cap") %>% pull(id)
phylogeny.in <- "plants"

best.fit.name <- myfit$score$dist[which.min(myfit$score$RMSE)]
best.fit.dat <- myfit$dists %>% select(one_of("Name", best.fit.name)) %>% rename(value := !!best.fit.name, params = Name)

leaf_water_cap_prior_id <- prior_input(bety, variable_id.in, phylogeny.in, 
                                       dist.name.in = best.fit.name, 
                                       parama.in = best.fit.dat %>% filter(params == "Para1") %>% pull(value), 
                                       paramb.in = best.fit.dat %>% filter(params == "Para2") %>% pull(value), 
                                       paramc.in = best.fit.dat %>% filter(params == "Para3") %>% pull(value))

```

```{r plot leaf_water_cap}
leaf_water_cap_fit <- tbl(bety, "priors") %>% filter(id == leaf_water_cap_prior_id) %>% collect()
leaf_water_cap_prior <- rdistn(leaf_water_cap_fit) * (1/1000)
leaf_water_cap_default <- get_ED_default("/fs/data3/ecowdery/ED.Hydro/parameters/pft3_defaults_history.xml", "leaf_water_cap")

prior_plot(prior = leaf_water_cap_prior, 
           q = c(0,.975),
           plot_default = leaf_water_cap_default,
           title = sprintf("(leaf_water_cap): %s", leaf_water_cap_fit$distn),
           type = "equation")

```

--------------------------------------------------------------------------------

# `[leaf_psi_min]:` Leaf minimum water potential  {-}

This is calculated from `[leaf_rwc_min]:` Leaf minimum relative water content or leaf residual fraction, which I have not added to BETY. 

## ED  {-}

- ED variable name : `leaf_psi_min`
- ED variable units: `m`

## BETY  {-}

- Variable id: `1000000299`
- Prior id: `1000000392`

NOTE!! The units are NEGATIVE in the database 
so we can calculate a distribution that is entirely negative. 

## Calculation  {-}

### Expert elicitation {-}

No expert elicitation provided by Brad Christoffersen. 

I will use the equation in ED to calcualte the prior and 
add min and max values to make sure the distribution 
does not predict values that are not biologically possible. 

Values added by Betsy and Felicien: 
```{r, eval = FALSE}
# Leaf_psi_min
priors[which(priors$ED_name == "leaf_psi_min"),
       c("theor.min", "theor.max")] <- c(-700, -0.1)
```

Code copied from ED: 

```
leaf_rwc_min = 0.01 * leaf_elastic_mod(ipft) + 0.17
leaf_psi_min = (leaf_rwc_min(ipft) - 1.) * leaf_water_sat(ipft) / leaf_water_cap(ipft)
```

### Conversion {-}

None

## Code {-}

```{r calc leaf_psi_min}
leaf_rwc_min_samp = 0.01 * leaf_elastic_mod_prior + 0.17
leaf_psi_min_samp = (leaf_rwc_min_samp - 1.) * leaf_water_sat_prior / leaf_water_cap_prior

# Add in the max an min from the priors table
i <- which(priors$ED_name == "leaf_psi_min")
prior_in <- priors[i,stats] * MPa2m # Convert from MPa to m
prior_in <- prior_add_samp_data(prior_in, samp = -leaf_psi_min_samp)
prior_in[,stats]

myfit <- prior_get_fit(prior_in, accepted_dists, plot = TRUE)

variable_id.in <- tbl(bety, "variables") %>% filter(name == "leaf_psi_min") %>% pull(id)
phylogeny.in <- "plants"

best.fit.name <- myfit$score$dist[which.min(myfit$score$RMSE)]
best.fit.dat <- myfit$dists %>% select(one_of("Name", best.fit.name)) %>% rename(value := !!best.fit.name, params = Name)

leaf_psi_min_prior_id <- prior_input(bety, variable_id.in, phylogeny.in, 
                                     dist.name.in = best.fit.name, 
                                     parama.in = best.fit.dat %>% filter(params == "Para1") %>% pull(value), 
                                     paramb.in = best.fit.dat %>% filter(params == "Para2") %>% pull(value), 
                                     paramc.in = best.fit.dat %>% filter(params == "Para3") %>% pull(value))

```

```{r plot leaf_psi_min}
leaf_psi_min_fit <- tbl(bety, "priors") %>% filter(id == leaf_psi_min_prior_id) %>% collect()
leaf_psi_min_prior <- -rdistn(leaf_psi_min_fit) # Remember to flip psi
default_leaf_psi_min <- get_ED_default("/fs/data3/ecowdery/ED.Hydro/parameters/pft3_defaults_history.xml", "leaf_psi_min")

prior_plot(prior = leaf_psi_min_prior, 
           q = c(.025,1), 
           plot_default = default_leaf_psi_min,
           title = sprintf("leaf_psi_min: %s", leaf_psi_min_fit$distn), 
           type = "equation")

```
